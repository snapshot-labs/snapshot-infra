version: '3.8'

services:
  snapshot:
    build:
      context: ${SNAPSHOT_REPO_PATH}
      dockerfile: ${PWD}/Dockerfiles/Dockerfile.snapshot
    ports:
      - "3002:3002"
    env_file:
      - ${SNAPSHOT_REPO_PATH}/.env
      - ./envs/.env.snapshot.local
    environment:
      PORT: 3002
    volumes:
      - ${SNAPSHOT_REPO_PATH}:/app
      - /app/node_modules
    command: yarn run vite --port=3002 --host
    depends_on:
      - snapshot-hub
      - snapshot-relayer
      - score-api

  snapshot-hub:
    build:
      context: ${SNAPSHOT_HUB_REPO_PATH}
      dockerfile: ${PWD}/Dockerfiles/Dockerfile.snapshot-hub
    ports:
      - "3000:3000"
    env_file:
      - ${SNAPSHOT_HUB_REPO_PATH}/.env
      - ./envs/.env.snapshot-hub.local
    environment:
      PORT: 3000
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - ${SNAPSHOT_HUB_REPO_PATH}:/app
      - /app/node_modules
    depends_on:
      mysql:
        condition: service_healthy
      snapshot-sequencer:
        condition: service_started

  keycard:
    build:
      context: ${KEYCARD_REPO_PATH}
      dockerfile: ${PWD}/Dockerfiles/Dockerfile.keycard
    ports:
      - "3005:3005"
    env_file:
      - ${KEYCARD_REPO_PATH}/.env
      - ./envs/.env.keycard.local
    environment:
      PORT: 3005
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - ${KEYCARD_REPO_PATH}:/app
      - /app/node_modules
    depends_on:
      mysql:
        condition: service_healthy

  snapshot-sequencer:
    build:
      context: ${SNAPSHOT_SEQUENCER_REPO_PATH}
      dockerfile: ${PWD}/Dockerfiles/Dockerfile.snapshot-sequencer
    ports:
      - "3001:3001"
    env_file:
      - ${SNAPSHOT_SEQUENCER_REPO_PATH}/.env
      - ./envs/.env.snapshot-sequencer.local
    environment:
      PORT: 3001
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - ${SNAPSHOT_SEQUENCER_REPO_PATH}:/app
      - /app/node_modules
    depends_on:
      mysql:
        condition: service_healthy

  score-api:
    build:
      context: ${SCORE_API_REPO_PATH}
      dockerfile: ${PWD}/Dockerfiles/Dockerfile.score-api
    ports:
      - "3003:3003"
    env_file:
      - ${SCORE_API_REPO_PATH}/.env
      - ./envs/.env.score-api.local
    environment:
      PORT: 3003
    volumes:
      - ${SCORE_API_REPO_PATH}:/app
      - /app/node_modules
    depends_on:
      - redis

  snapshot-relayer:
    build:
      context: ${SNAPSHOT_RELAYER_REPO_PATH}
      dockerfile: ${PWD}/Dockerfiles/Dockerfile.snapshot-relayer
    ports:
      - "3004:3004"
    env_file:
      - ${SNAPSHOT_RELAYER_REPO_PATH}/.env
      - ./envs/.env.snapshot-relayer.local
    environment:
      PORT: 3004
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - ${SNAPSHOT_RELAYER_REPO_PATH}:/app
      - /app/node_modules
    depends_on:
      mysql:
        condition: service_healthy
    
  envelop:
    build:
      context: ${ENVELOP_REPO_PATH}
      dockerfile: ${PWD}/Dockerfiles/Dockerfile.envelop
    ports:
      - "3006:3006"
    env_file:
      - ${ENVELOP_REPO_PATH}/.env
      - ./envs/.env.envelop.local
    environment:
      PORT: 3006
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - ${ENVELOP_REPO_PATH}:/app
      - /app/node_modules
    depends_on:
      mysql:
        condition: service_healthy

  envelop-ui:
    build:
      context: ${ENVELOP_UI_REPO_PATH}
      dockerfile: ${PWD}/Dockerfiles/Dockerfile.envelop-ui
    ports:
      - "3007:3007"
    env_file:
      - ${ENVELOP_UI_REPO_PATH}/.env
      - ./envs/.env.envelop-ui.local
    environment:
      - PORT=3007
    volumes:
      - ${ENVELOP_UI_REPO_PATH}:/app
      - /app/node_modules
    command: yarn run vite --port=3007 --host
    depends_on:
      - envelop

  mysql:
    build: ./mysql
    command: --default-authentication-plugin=mysql_native_password
    cap_add:
      - SYS_NICE
    ports:
      - '3306:3306'
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    volumes:
      - mysql:/var/lib/mysql
      - ${SNAPSHOT_RELAYER_REPO_PATH}/src/schema.sql:/schemas/snapshot-relayer/schema.sql
      - ${SNAPSHOT_SEQUENCER_REPO_PATH}/src/helpers/schema.sql:/schemas/snapshot-sequencer/schema1.sql
      - ${SNAPSHOT_HUB_REPO_PATH}/src/helpers/schema.sql:/schemas/snapshot-sequencer/schema2.sql
      - ${KEYCARD_REPO_PATH}/src/helpers/schema.sql:/schemas/keycard/schema.sql
      - ${ENVELOP_REPO_PATH}/src/helpers/schema.sql:/schemas/envelop/schema.sql
      # fixtures
      - ./mysql/fixtures/keycard.fixtures.sql:/schemas/keycard/fixtures/keycard.fixtures.sql
    healthcheck:
        test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
        timeout: 10s
        retries: 10

  redis:
    image: redis:alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis:/data

volumes:
  mysql:
    driver: local
  redis:
    driver: local
